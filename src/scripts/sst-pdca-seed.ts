import { PrismaClient, ProjectType, TarefaStatus } from '@prisma/client'

const prisma = new PrismaClient()

// Interface para os dados do checklist
interface ChecklistData {
  title: string
  description: string
  type: string
  phases: {
    [key: string]: {
      title: string
      description: string
      tarefas: Array<{
        titulo: string
        descricao: string
        responsavel: string
        prazo: string
        status: string
        prioridade: string
      }>
    }
  }
  metas: {
    [key: string]: string
  }
  legislacoes: string[]
}

// Dados do checklist (hardcoded para evitar problemas de import)
const checklistData: ChecklistData = {
  "title": "Checklist SST - Ciclo PDCA para Ergonomia e Fatores Psicossociais",
  "description": "Checklist baseado na NR-1 subitem 1.5.3.4 e ISO 45001:2018 com foco em ergonomia e ISO 45003:2021 para fatores psicossociais",
  "type": "checklist",
  "phases": {
    "PLAN": {
      "title": "PLAN - Planejar",
      "description": "Fase de planejamento e identifica√ß√£o de riscos",
      "tarefas": [
        {
          "titulo": "An√°lise de Riscos Ergon√¥micos",
          "descricao": "Identificar e avaliar riscos ergon√¥micos nos postos de trabalho, incluindo movimentos repetitivos, posturas inadequadas e sobrecarga muscular",
          "responsavel": "Engenheiro de Seguran√ßa do Trabalho",
          "prazo": "30 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Avalia√ß√£o de Fatores Psicossociais",
          "descricao": "Aplicar question√°rios e realizar entrevistas para identificar fatores psicossociais de risco (estresse, ass√©dio, sobrecarga de trabalho)",
          "responsavel": "Psic√≥logo do Trabalho",
          "prazo": "45 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Mapeamento de Postos de Trabalho",
          "descricao": "Mapear todos os postos de trabalho da organiza√ß√£o com foco em ergonomia e condi√ß√µes psicossociais",
          "responsavel": "T√©cnico de Seguran√ßa",
          "prazo": "20 dias",
          "status": "pendente",
          "prioridade": "m√©dia"
        },
        {
          "titulo": "Defini√ß√£o de Metas e Objetivos",
          "descricao": "Estabelecer metas mensur√°veis para redu√ß√£o de riscos ergon√¥micos e psicossociais",
          "responsavel": "Coordenador de SST",
          "prazo": "15 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Planejamento de Recursos",
          "descricao": "Definir recursos necess√°rios (humanos, financeiros e materiais) para implementa√ß√£o das a√ß√µes",
          "responsavel": "Gerente de RH",
          "prazo": "25 dias",
          "status": "pendente",
          "prioridade": "m√©dia"
        }
      ]
    },
    "DO": {
      "title": "DO - Fazer",
      "description": "Fase de implementa√ß√£o das a√ß√µes planejadas",
      "tarefas": [
        {
          "titulo": "Implementa√ß√£o de Melhorias Ergon√¥micas",
          "descricao": "Executar melhorias nos postos de trabalho: ajuste de mobili√°rio, ilumina√ß√£o, temperatura e ru√≠do",
          "responsavel": "Equipe de Manuten√ß√£o",
          "prazo": "60 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Treinamento em Ergonomia",
          "descricao": "Capacitar colaboradores sobre posturas corretas, alongamentos e uso adequado de equipamentos",
          "responsavel": "Instrutor de SST",
          "prazo": "30 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Programa de Gest√£o de Estresse",
          "descricao": "Implementar programa de gest√£o de estresse com t√©cnicas de relaxamento e mindfulness",
          "responsavel": "Psic√≥logo Organizacional",
          "prazo": "45 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Reestrutura√ß√£o de Processos",
          "descricao": "Reorganizar processos de trabalho para reduzir sobrecarga e melhorar distribui√ß√£o de tarefas",
          "responsavel": "Analista de Processos",
          "prazo": "90 dias",
          "status": "pendente",
          "prioridade": "m√©dia"
        },
        {
          "titulo": "Implementa√ß√£o de Pausas Programadas",
          "descricao": "Estabelecer sistema de pausas programadas para trabalhos repetitivos e mon√≥tonos",
          "responsavel": "Supervisor de Produ√ß√£o",
          "prazo": "20 dias",
          "status": "pendente",
          "prioridade": "m√©dia"
        }
      ]
    },
    "CHECK": {
      "title": "CHECK - Verificar",
      "description": "Fase de monitoramento e verifica√ß√£o das a√ß√µes implementadas",
      "tarefas": [
        {
          "titulo": "Avalia√ß√£o P√≥s-Implementa√ß√£o",
          "descricao": "Realizar nova avalia√ß√£o ergon√¥mica para verificar efetividade das melhorias implementadas",
          "responsavel": "Engenheiro de Seguran√ßa",
          "prazo": "30 dias ap√≥s implementa√ß√£o",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Monitoramento de Indicadores",
          "descricao": "Acompanhar indicadores de sa√∫de: absente√≠smo, LER/DORT, acidentes de trabalho e queixas psicossociais",
          "responsavel": "Analista de RH",
          "prazo": "Cont√≠nuo",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Pesquisa de Satisfa√ß√£o",
          "descricao": "Aplicar pesquisa de satisfa√ß√£o para avaliar percep√ß√£o dos colaboradores sobre as melhorias",
          "responsavel": "Psic√≥logo Organizacional",
          "prazo": "60 dias ap√≥s implementa√ß√£o",
          "status": "pendente",
          "prioridade": "m√©dia"
        },
        {
          "titulo": "Auditoria de Conformidade",
          "descricao": "Realizar auditoria para verificar conformidade com NR-1, ISO 45001 e legisla√ß√µes aplic√°veis",
          "responsavel": "Auditor de SST",
          "prazo": "90 dias ap√≥s implementa√ß√£o",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "An√°lise de Efetividade",
          "descricao": "Analisar dados coletados para determinar efetividade das a√ß√µes implementadas",
          "responsavel": "Analista de Dados",
          "prazo": "45 dias ap√≥s implementa√ß√£o",
          "status": "pendente",
          "prioridade": "m√©dia"
        }
      ]
    },
    "ACT": {
      "title": "ACT - Agir",
      "description": "Fase de corre√ß√£o e melhoria cont√≠nua",
      "tarefas": [
        {
          "titulo": "Identifica√ß√£o de N√£o-Conformidades",
          "descricao": "Identificar a√ß√µes que n√£o atingiram os resultados esperados e necessitam de corre√ß√£o",
          "responsavel": "Coordenador de SST",
          "prazo": "15 dias ap√≥s verifica√ß√£o",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Planejamento de Corre√ß√µes",
          "descricao": "Desenvolver plano de a√ß√£o para corre√ß√£o das n√£o-conformidades identificadas",
          "responsavel": "Engenheiro de Seguran√ßa",
          "prazo": "30 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Implementa√ß√£o de Corre√ß√µes",
          "descricao": "Executar as corre√ß√µes necess√°rias baseadas nos resultados da verifica√ß√£o",
          "responsavel": "Equipe de Implementa√ß√£o",
          "prazo": "60 dias",
          "status": "pendente",
          "prioridade": "alta"
        },
        {
          "titulo": "Atualiza√ß√£o de Procedimentos",
          "descricao": "Revisar e atualizar procedimentos de SST com base nas li√ß√µes aprendidas",
          "responsavel": "T√©cnico de SST",
          "prazo": "45 dias",
          "status": "pendente",
          "prioridade": "m√©dia"
        },
        {
          "titulo": "Planejamento do Pr√≥ximo Ciclo",
          "descricao": "Definir objetivos e metas para o pr√≥ximo ciclo PDCA, incorporando melhorias cont√≠nuas",
          "responsavel": "Gerente de SST",
          "prazo": "30 dias",
          "status": "pendente",
          "prioridade": "alta"
        }
      ]
    }
  },
  "metas": {
    "reducao_ler_dort": "Reduzir casos de LER/DORT em 30% no primeiro ano",
    "reducao_estresse": "Reduzir n√≠veis de estresse reportados em 25%",
    "melhoria_ergonomia": "100% dos postos cr√≠ticos com melhorias ergon√¥micas implementadas",
    "treinamento": "100% dos colaboradores treinados em ergonomia e fatores psicossociais",
    "conformidade": "100% de conformidade com NR-1 e ISO 45001"
  },
  "legislacoes": [
    "NR-1 - Disposi√ß√µes Gerais (subitem 1.5.3.4)",
    "ISO 45001:2018 - Sistemas de Gest√£o de SST",
    "ISO 45003:2021 - Fatores Psicossociais de Risco",
    "NR-17 - Ergonomia",
    "Lei 8.213/91 - Benef√≠cios por Incapacidade"
  ]
}

async function main() {
  console.log('üå± Iniciando seed do checklist SST - PDCA...')

  try {
    // Buscar uma organiza√ß√£o existente ou criar uma de teste
    let organization = await prisma.organization.findFirst()
    
    if (!organization) {
      console.log('üìã Criando organiza√ß√£o de teste...')
      organization = await prisma.organization.create({
        data: {
          name: 'Organiza√ß√£o de Teste SST',
          slug: 'org-teste-sst',
          inviteCode: 'SST-TESTE-2024',
          type: 'Empresa',
          numberOfEmployees: '100-500',
          corporateEmail: 'sst@teste.com'
        }
      })
      console.log('‚úÖ Organiza√ß√£o criada:', organization.name)
    }

    // Criar projeto do tipo checklist
    console.log('üìã Criando projeto SST - PDCA...')
    const project = await prisma.project.create({
      data: {
        title: checklistData.title,
        slug: 'sst-pdca-checklist',
        type: 'checklist' as ProjectType,
        description: checklistData.description,
        organizationId: organization.id,
        status: 'pending'
      }
    })
    console.log('‚úÖ Projeto criado:', project.title)

    // Criar tarefas para cada fase do PDCA
    let totalTarefas = 0
    
    for (const [phaseKey, phase] of Object.entries(checklistData.phases)) {
      console.log(`üìã Criando tarefas da fase: ${phase.title}`)
      
      for (const tarefaData of phase.tarefas) {
        // Converter prazo para data
        let dataPrevisaoConclusao: Date | null = null
        
        if (tarefaData.prazo !== 'Cont√≠nuo') {
          const dias = parseInt(tarefaData.prazo.split(' ')[0])
          dataPrevisaoConclusao = new Date(Date.now() + dias * 24 * 60 * 60 * 1000)
        }

        // Mapear prioridade para status
        let status: TarefaStatus = 'pendente'
        if (tarefaData.prioridade === 'alta') {
          status = 'pendente'
        } else if (tarefaData.prioridade === 'm√©dia') {
          status = 'pendente'
        }

        const tarefa = await prisma.tarefa.create({
          data: {
            titulo: tarefaData.titulo,
            descricao: tarefaData.descricao,
            responsavel: tarefaData.responsavel,
            dataInicio: new Date(),
            dataPrevisaoConclusao,
            status,
            projectId: project.id
          }
        })
        
        totalTarefas++
        console.log(`  ‚úÖ Tarefa criada: ${tarefa.titulo}`)
      }
    }

    console.log(`üéâ Seed conclu√≠do! Criadas ${totalTarefas} tarefas para o projeto SST - PDCA`)
    console.log(`üìä Projeto ID: ${project.id}`)
    console.log(`üè¢ Organiza√ß√£o: ${organization.name}`)

    // Exibir resumo das fases
    console.log('\nüìã Resumo das Fases PDCA:')
    for (const [phaseKey, phase] of Object.entries(checklistData.phases)) {
      const tarefasCount = phase.tarefas.length
      console.log(`  ${phase.title}: ${tarefasCount} tarefas`)
    }

    // Exibir metas
    console.log('\nüéØ Metas do Projeto:')
    for (const [key, meta] of Object.entries(checklistData.metas)) {
      console.log(`  ‚Ä¢ ${meta}`)
    }

    // Exibir legisla√ß√µes
    console.log('\nüìö Legisla√ß√µes Base:')
    checklistData.legislacoes.forEach(leg => {
      console.log(`  ‚Ä¢ ${leg}`)
    })

  } catch (error) {
    console.error('‚ùå Erro durante o seed:', error)
    throw error
  } finally {
    await prisma.$disconnect()
  }
}

main()
  .catch((e) => {
    console.error('‚ùå Erro no seed:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
